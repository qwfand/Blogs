# 计算机网络

## 路由器

实现分组交换的关键构建，其任务是转发收到的分组

处理分组的过程：
- 把收到的分组先放入缓存
- 查找转发表，找到某个目的地址应从哪个端口转发
- 把分组送到合适的端口转发出去

## 体系结构

TCP/IP 是四层：应用层、运输层、网际层、网络接口层

五层协议（教学）：应用层、运输层、网络层、数据链路层、物理层

|层名|功能|协议|数据|描述|
|:-  |:-  |:-  |:- |:-  |
|应用层|确定进程间通讯的性质以满足用户需求|HTTP、SMTP、FTP等|提供应用进程所需的信息交换和远程操作|做什么|
|运输层|负责进程间通讯，端到端数据传输|TCP、UDP|报文段、用户数据报|对方在那|
|网络层|负责主机间通讯（分组传送，路由选择，流量控制）|无连接的网际协议IP、地址解析协议ARP|IP数据报|走那条路可以到达对方|
|数据链路层|相邻结点无差错地传送帧|停止等待协议、HDLC、PPP协议|帧frame|每一步该怎么走|
|物理层|在物理谋体上透明传输比特流|接口标准|比特流|怎样利用物理媒体|

## 物理层

## 数据链路层

### 使用点对点信道的数据链路层

一对一的点对点通信

#### 数据链路和帧

#### 三个基本问题

封装成帧

加上首部和尾部

透明传输
    字节填充

差错控制

循环冗余检验

### 点对点协议PPP


### 使用广播信道的数据链路层

一对多的广播通信
CSMA/CD协议：载波监听多点接入/碰撞检测

### 扩展的以太网

### 高速以太网


### 无线局域网

## 网络层

### 网络层提供的两种服务

无连接的、尽最大努力交付的数据服务

### 网际协议IP

与ip协议配套的还有三个协议：
- 地址解析协议ARP（Address Resolution Protocol）
- 网际控制报文协议ICMP（Internet Control Message Protocol）
- 网际组管理协议IGMP（Internet Group Management Protocol）

#### 虚拟互联网络

如何将异构的网络互相连接起来？
使用中间设备：
物理层：转发器
数据链路层：网桥或桥接器
网络层：路由器
网桥和路由器的混合物：桥路器
网络层以上：网关

#### 分类的IP地址

IPv4 32 bits 4bytes
IPv6 128 bits 16bytes

ip地址=net-id + host-id

A类 ：0（前导码）+7 bits net-id--》1. ~ 127.
B类：10（前导码）14 bits net-id--》128.0 ~ 191.255
C类：110+21 bits net-id---》192.0.0 ~223.255.255
D类：1110+多播地址

路由器只根据目的站的ip地址的网络号进行路由选择

路由器转发分组的步骤：
- 先按照net-id找到目的网络
- 到达目的网络，用 host-id直接交付主机

转发算法：
（1）从数据报首部崎岖目的站的IP地址D，得到网络号N
（2）若网络N与此路由器直接相连，直接将数据报交付目的站D，否则间接交付
（3）如果路由表中有目的站为D的特定主机路由，则将数据报传送给路由表中所指明的下一跳路由器，否则
（4）若路由表中有到达网络N的路由，则将数据报传送给路由表指定的下一跳路由器，否则
（4）若有默认路由，则传送给默认路由，否则
（5）报告转发分组出错

划分子网
（1）从数据报首部崎岖目的站的IP地址D
（2）先用本网络的子网掩码和D逐位相与，看是否和相应的网络号匹配，若匹配则直接交付，否则间接交付
（3）如果路由表中有目的站为D的特定主机路由，则将数据报传送给路由表中所指明的下一跳路由器，否则
（4）对路由表中的每一行的子网掩码与D and，若结果与该行的网络地址匹配，则交给该行指明的下一跳路由器，否则
（5）若有默认路由，则传送给默认路由，否则
（6）报告转发分组出错

#### IP地址与硬件地址

硬件地址（MAC地址）-数据链路层和物理层
IP地址-网络层及以上，是一种逻辑地址
路由器根据目的站的IP地址的网络号进行路由选择

#### 地址解析协议ARP

从网络层使用的IP地址，解析出在数据链路层使用的硬件地址

每一个主机都有一个ARP高速缓存，里面有所在局域网上个主机和路由器的ip地址到硬件的地址的映射

(IP address, MAC address, TTL)
TTL(time to live)地址映射有效时间

当主机A欲向本局域网上某个主机B发送IP数据报时，先查看ARP cache

- 有，将硬件地址写入MAC帧，再通过局域网将该MAC帧发往硬件地址
- ARP进程在本局域网广播发送一个ARP请求分组，收到响应分组后，将IP to MAC 的映射写出ARP cache

注：
- ARP解决同一个局域网上的主机或路由器的IP地址到硬件地址的映射
- 不在同一个局域网时，ARP找到一个本局域网的路由器的硬件地址，然后把分组发送给这个路由器，路由器再把分组发给下一个网络
- 本地广播ARP请求（路由器不转发ARP请求）
- 将下一跳的Ip地址转化为MAC地址


#### IP数据报的格式

源地址 | 目的地址

#### IP层转发分组的流程

按主机所在的网络地址来制作路由表
（目的网络地址，下一跳地址）

主机也有路由表，在本网络中直接交付，否则交给路由器


### 划分子网和构造超网

#### 划分子网

两级IP网络边三层IP网络
IP地址::=(网络号，子网号，主机号)

#### 使用子网掩码的分组转发过程

IP  and mask = net-id

使用子网掩码可以得出网络号和子网号
路由表变成（网络号，子网掩码，下一跳地址）

#### 无分类编码CIDR，构造超网

ip地址=（网络前缀，主机号）
斜线激发128.14.32.0/20
20表示网络前缀的比特数（对于子网掩码中1的个数）

路由表=（网络前缀，下一跳）
最长前缀匹配
    使用二叉线索查找路由表

### 网际控制报文协议ICMP

### 互联网的路由选择协议

自治系统AS（Autonomous System）

内部网关协议IGP（Interior Gateway Protocol）
    一个自治系统内部使用的路由选择协议
    RIP（Routing Information Protocol）
    OSPF（Open Shortest Path First）

外部网关协议EGP（External Gateway Protocol）
    源站和目的站处在不同的自治系统中，当数据报到达一个自治系统的边界时，就需要使用EGP将路由选择信息传递到另一自治系统中
    BGP-4

#### 内部网关协议RIP

#### 内部网关协议OSPF

#### 外部网关协议BGP

### IP多播

### 虚拟专用网VPN和网络地址转换NAT

Virtual Private Network VPN
Network Address Translation

用隧道技术实现虚拟专网



本地地址：仅在机构内部使用的IP地址
全球地址：全球唯一的IP地址

本地专用地址：
A类：10.0.0.0-10.255.255.255
B类：172.16.0.0-172.31.31.255.255
C类：192.168.0.0-192.168.255.255

内部通信：
在互联网中所有的路由器对目的地址是专用地址的数据报一律不进行转发

需要再爱专用网连接到互联网的路由器上安装NAT软件-NAT路由器

网络地址转换过程：
（1） 内部主机用本地地址IPx和互联网上的主机Y通信所发送的数据报必须经过NAT路由器
（2）NAT路由器将数据报的原地址IPx转换成全球地址IPg，目的地址IPy不变，然后发送到互联网
（3）NAT路由器收到主机发回的数据报时，知道数据报中源地址是IPy，目的地址是IPg
（4）根据NAT转换表，NAT路由器将目的地址IPg转换为IPx，转发给内部主机X

NAT：
多个内部主机访问同一外部主机
转换表利用端口区分不同的内部主机

### IPv6

ip地址 ：32bit-》128 bit
使用双协议站进行过渡
使用隧道技术从IPv4先IPv6过渡

## 运输层

### 概述

运输层为相互通信的应用进程提供了逻辑通信
IP协议提供主机之间的逻辑通信

端口：
端口号只是为了标志计算机应用层中的各进程在和运输层交互时的层间接口 

### 用户数据报协议UDP（User Datagram Protocol）

特点：
- 无连接的传输数据前不需要先建立连接。对方的运输层在收到UDP报文后，不需要给出确认。
- 使用尽最大努力的交付，不保证可靠交互，不使用拥塞控制
- 面向报文的（对应用层交下来的报文，不合并也不拆分，加上UDP首部就传送到网络层），一次发送一个报文，应用程序必须选择合适的报文大小
- UDP没有拥塞控制，适合多媒体通信的要求
- UDP支持一对一，一对多，多对一和多对多的交互通信
- 首部开销小8bytes，TCP首部20bytes
RPC
DNS
TFTP
SNMP


### 传输控制协议TCP

特点：
- 面向连接
- 每一条TCP连接只能有两个端点
- 提供可靠交付，无差错、不丢失、不重复、按序到达
- 提供全双工通信，通信双方的应用进程在任何时候都能发送和接收数据
- 面向字节流，应用程序和TCP的交互是一次一个数据块（大小不等），TCP把应用程序交下来的数据看出仅仅是一连串的无结构的字节流

TCP的端点是套接字==（IP地址：端口号）

不提供广播和多播服务
SMTP
FTP
Telnet
HTTP
HTTPS

### 可靠传输的工作原理

停止等待协议
    超时重传
    确认丢失和确认迟到，再次受到是，发送确认
    自动重传请求ARQ（Automatic Repeat reQuest）
连续ARQ协议
    发送窗口
    累积确认：对按序到达的最后一个分组发送确认
    回退N：退回来重传已发送过的N个分组

### TCP报文段的首部格式

    源端口|目的端口
    序号：本报文段所发送的数据的第一个字节的序号
    确认号：期望受到对方的下一个报文段的数据的第一个字节的序号

### TCP可靠传输的实现

以字节为单位的滑动窗口
    发送窗口
    接收窗口
超时重传
    TCP每发送一个报文段，就对这个报文段设置一次计时器，只要计时器设置的重传时间已到但没有收到确认，就要重传
选择确认
    接收到的字节流序号不连续

### TCP利用滑动窗口实现流量控制

### TCP的拥塞控制

### TCP运输连接管理

TCP连接的建立-三报文握手
    防止已失效的连接请求报文突然有传送到了，而函数错误
TCP连接的释放-四报文握手

## 应用层

### 域名系统DNS

域名的解析构成：
> - 应用进程成为域名系统的一个客户，将带解析的域名放在DNS请求报文中，以UDP数据报的方式发给本地域名服务器。本地域名服务器在查找域名后，将对应的IP地址放在回答报文中返回
> - 若本地域名服务器不能回答该请求，再转向其他域名服务器发出请求，直至找到
> - 根域名服务器把下一步应当找的顶级服务器的IP地址告诉本地域名服务器
> - 每一个域名服务器都有高速缓存

### 文件传输

FTP （File Transfer Protocol）

FTP工作原理
- 基于TCP
- 功能：减少或消除不同操作系统下处理文件的不兼容性
- client/server
- 使用两个TCP连接：TCP控制连接和TCP数据连接

简单文件传送协议TFTP（Trivial FTP）
- 基于UDP

### 远程终端协议TELNET

- 基于TCP
- 网络虚拟终端（NVT）

### WWW

- URL（统一资源定位符）
> <URL的访问方式> :// <主机> ： <端口>/<路径>
- HTTP（超文本传输协议 HyperText Transfer Protocol）
- HTML（超文本标记语言 HyperText Markup Language）

#### HTTP

浏览器输入回车：
- 浏览器分析是URL还是搜索的关键字
- 浏览器想DNS请求解析URL中主机的IP地址
- 域名服务器DNS解析并返回IP地址
- 浏览器与服务器建立TCP连接
- 浏览器发出HTTP请求报文（GET）
- 服务器给出相应
- TCP连接释放
- 浏览器显示

HTTP的特点

- 面向事务的客户服务器协议
- 1.0协议是无状态的
- HTTP虽然使用了TCP，但本身是无连接的
- 在万维网服务器等待HTTP请求的进程称为HTTP守护进程

- 1.1协议使用持续连接
    - 一段时间内保持连接，可以继续HTTP请求报文和相应报文

代理服务器（proxy server）/web cache-万维网告诉缓存
- 把最近一些请求和相应暂存在本地
- 与暂存相同的新请求到达时，直接发送相应
- 无暂存，代理服务器就代表发出请求的浏览器，与互联网上的源点服务器建立TCP连接，发送HTTP请求报文

HTTP 的报文结构

- 请求报文-从客服向服务器发送请求报文
    开始行： 方法 URL 版本
    &emsp;首部字段名：值

    方法有：
    OPTION、GET、HEAD、POST、PUT、DELETE、TRACE、CONNECT
- 相应报文-服务器到客户的回答
    开始行：版本 状态码 短语

    状态码：
        1XX：通知信息，eg：请求收到了or正在进行处理
        2XX：“成功，eg：接收or知道了
        3XX：重定向，要完成请求还必须采取进一步行动
        4XX：客户的差错，eg：请求中有错误的语法or不能完成
        5XX：服务器的差错，eg：服务器失效无法完成请求

Cookie 在服务器上存放用户的信息

### 电子邮件

简单邮件传送协议SMTP

电子邮件的信息格式

邮件读取协议POP3和IMAP
Post Office Protocol
Internet Message Access Protocol

### 动态主机配置协议DHCP

### 简单网络管理协议SNMP

### 应用进程跨网络的通信

### P2P
